
#include "header.h"

static const double threshold[] = {
  17.5, 18.5, 19, 19.5, 20, 20.5, 21, 21.5, 22, 22.5, 23, 23.5, 24, 24.5, 25, 
  25.5, 26, 26.5, 27, 27.5, 28, 28.5, 29, 29.5, 30, 30.5, 31, 31.5, 32, 32.5, 
  33, 33.5, 34, 34.5, 35, 35.5, 36, 36.5, 37, 37.5, 38, 38.5, 39, 39.5, 40, 
  40.5, 41, 41.5, 42, 42.5, 43, 43.5, 44, 44.5, 45, 45.5, 46, 46.5, 47, 47.5, 
  48, 48.5, 49, 49.5, 50, 50.5, 51, 51.5, 52, 52.5, 53, 53.5, 54, 54.5, 55, 
  55.5, 56, 56.5, 57, 57.5, 58, 58.5, 59, 59.5, 60, 60.5, 61, 61.5, 62, 62.5, 
  63, 63.5, 64, 64.5, 65, 65.5, 66, 66.5, 67, 67.5, 68, 68.5, 69, 69.5, 70, 
  70.5, 71, 71.5, 72, 72.5, 73, 73.5, 74, 74.5, 75, 75.5, 76, 76.5, 77, 77.5, 
  78, 78.5, 79, 79.5, 80, 80.5, 81, 81.5, 82, 82.5, 83, 83.5, 84.5, 85.5, 88.5, 
  0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 
  0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 
  0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1500, 
  2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000, 6500, 7000, 7500, 8000, 
  8500, 9000, 9500, 10000, 10500, 11000, 11500, 12000, 12500, 13000, 13500, 
  14000, 14500, 15500, 16000, 16500, 17500, 18500, 20500, 22500, 24500, 500, 
  1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000, 6500, 7000, 
  7500, 8000, 8500, 9000, 9500, 10000, 10500, 11000, 11500, 12500, 13000, 
  13500, 14000, 14500, 15000, 15500, 16500, 17000, 17500, 18500, 500500, 
  501000, 501500, 502000, 502500, 503000, 503500, 504000, 504500, 505000, 
  505500, 506000, 506500, 507000, 507500, 508000, 508500, 510000, 510500, 
  512000, 513000, 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5500, 
  6000, 6500, 0.5, 0.5, 0.5, -3200, -3150, -2950, -2600, -2550, -2400, -2350, 
  -2300, -2250, -2000, -1750, -1450, -1400, -1000, -950, -750, -650, -600, 
  -350, -300, -200, -150, 500, 650, 1250, 92290, 92316, 92335, 92405, 92424, 
  92425, 92450, 92514, 92522, 92540, 92546, 92559, 92572, 92582, 92591, 
  92593.5, 92638, 92681, 92716, 92746, 92771, 92778, 92824.5, 92838, 92868, 
  92900, 92903, 92915.5, 92919, 92928, 92959, 92984, 93009, 93019, 93038.5, 
  93041, 93046.5, 93081.5, 93106, 93114, 93137.5, 93166, 93168.5, 93199, 93200, 
  93222, 93231, 93262.5, 93289, 93294.5, 93322, 93334, 93338, 93342, 93356, 
  93370, 93384, 93384.5, 93405.5, 93419.5, 93460, 93474.5, 93475.5, 93495, 
  93499, 93509, 93516, 93559, 93581, 93589, 93597, 93622.5, 93657, 93681, 
  93698, 93708, 93712, 93714, 93719, 93784, 93792, 93812.5, 93830, 93858, 
  93888, 93896, 93902, 93921, 93951.5, 93954.5, 93956, 93965.5, 93974, 94037.5, 
  94041, 94045.5, 94113, 94121, 94127, 94135, 94191.5, 94199.5, 94207, 94229.5, 
  94314, 94321.5, 94328, 94397, 94400, 94408, 94483, 94491, 94684, -50150, 
  -49750, -48950, -48550, -48500, -48300, -48100, -47850, -46650, -46050, 
  -45800, -45550, -45300, -45150, -44950, -44900, -44750, -44650, -44550, 
  -44450, -44300, -44150, -44100, -44000, -43950, -43900, -43500, -43350, 
  -43250, -43100, -42800, -42700, -42400, -42350, -42250, -42050, -41900, 
  -41800, -41500, -41200, -41150, -41100, -40700, -40550, -40450, -40400, 
  -40300, -40150, -40050, -39900, -39600, -39550, -39400, -39300, -39200, 
  -39150, -39100, -39050, -38950, -38900, -38750, -38650, -38400, -38250, 
  -38200, -37900, -37800, -37550, -37450, -37400, -37300, -37200, -36950, 
  -36900, -36800, -36550, -36450, -36250, -36150, -36100, -36050, -35950, 
  -35700, -35650, -35600, -35550, -35450, -35350, -35250, -34950, -34850, 
  -34700, -34200, -34100, -33900, -33850, -33800, -33650, -33300, -32500, 
  -32350, -32200, -31850, -31700, -31550, -31400, -30850, -30750, -30600, 
  -29950, -29150, -28500, -28350, 634.5, 635, 635.5, 636, 636.5, 637, 637.5, 
  638, 638.5, 639, 640, 640.5, 641, 641.5, 642, 642.5, 643, 643.5, 644, 644.5, 
  645, 645.5, 646, 647, 647.5, 648, 648.5, 649, 649.5, 650.5, 651, 651.5, 652, 
  652.5, 653, 653.5, 654.5, 656.5, 658, 659, 660, 661, 661.5, 663, 663.5, 664, 
  666, 670, 671.5, 672.5, 674, 674.5, 677, 677.5, 679.5, 680, 681, 681.5, 
  682.5, 683, 683.5, 684, 684.5, 686, 686.5, 689.5, 691, 691.5, 693, 693.5, 
  695, 696, 698, 699, 699.5, 700, 703, 704.5, 705, 706.5, 707, 707.5, 708, 
  708.5, 709, 709.5, 710, 710.5, 711, 711.5, 712, 712.5, 713, 713.5, 714, 
  714.5, 715, 715.5, 716, 716.5, 717, 717.5, 718, 718.5, 719, 719.5, 720, 
  720.5, 721, 721.5, 722, 722.5, 723, 723.5, 724, 724.5, 725, 726, 726.5, 727, 
  727.5, 728.5, 729.5, 730, 731.5, 732, 732.5, 733.5, 734, 734.5, 735, 735.5, 
  736, 736.5, 737, 738, 738.5, 739.5, 740, 740.5, 741, 741.5, 742, 742.5, 743, 
  743.5, 745, 745.5, 746, 747, 747.5, 748, 748.5, 749, 750, 751, 752.5, 753, 
  754.5, 755, 755.5, 756, 757.5, 759, 759.5, 760.5, 761, 764, 765.5, 766, 
  769.5, 770, 770.5, 771, 771.5, 772, 773, 774, 775, 775.5, 776, 777.5, 778, 
  779, 779.5, 780.5, 782, 785, 786, 788.5, 789, 789.5, 790.5, 792.5, 793.5, 
  794.5, 795.5, 797, 798.5, 799.5, 800, 800.5, 801.5, 803, 803.5, 806, 808, 
  808.5, 810, 811, 811.5, 812, 814, 816, 818, 818.5, 822.5, 823, 824.5, 825, 
  826, 827.5, 828.5, 830, 831, 831.5, 832, 833.5, 835.5, 836, 836.5, 837, 839, 
  840, 840.5, 841, 841.5, 843.5, 844, 846, 847, 848, 848.5, 851, 851.5, 852, 
  852.5, 853, 853.5, 855, 855.5, 856, 856.5, 857.5, 858, 859, 859.5, 860, 
  860.5, 861, 861.5, 862, 862.5, 863, 863.5, 864, 864.5, 865, 866, 866.5, 867, 
  868.5, 869.5, 871, 871.5, 872, 872.5, 873, 874, 875, 876, 876.5, 877, 877.5, 
  878, 878.5, 879.5, 880, 880.5, 881, 881.5, 882, 882.5, 883, 883.5, 884.5, 
  885, 886, 887.5, 888.5, 889, 889.5, 891, 892, 892.5, 893, 894, 894.5, 895.5, 
  896, 897, 898.5, 899, 899.5, 900.5, 901, 901.5, 902, 902.5, 903.5, 904.5, 
  906.5, 908.5, 909.5, 913, 918.5, 923.5, 933, 934.5, 935, 935.5, 936.5, 940.5, 
  941, 943, 953.5, 955.5, 962, 963.5, 964, 966, 966.5, 968, 968.5, 969, 970, 
  971.5, 974.5, 976, 977, 979.5, 981, 982, 983, 986, 986.5, 987.5, 988.5, 990, 
  992.5, 993.5, 995, 995.5, 998, 998.5, 999.5, 1000.5, 1001, 1002, 1004, 
  1004.5, 1005.5, 1006, 1007, 1008, 1009, 1012, 1012.5, 1013.5, 1014, 1016, 
  1018, 1018.5, 1020, 1020.5, 1023.5, 1027, 1029.5, 1030, 1030.5, 1032.5, 
  1033.5, 1034, 1034.5, 1035.5, 1036, 1036.5, 1037.5, 1038, 1039, 1039.5, 1040, 
  1040.5, 1043.5, 1044, 1044.5, 1045, 1046, 1046.5, 1047, 1047.5, 1049.5, 
  1050.5, 1051.5, 1053.5, 1055.5, 1057, 1058, 1064, 1065.5, 1066.5, 1070.5, 
  1072.5, 1078.5, 1079, 1087.5, 1092, 1123.5, 1131.5, 1145.5, 1152.5, 1155, 
  1163.5, 1171.5, 1179.5, 1180.5, 1190.5, 1209, 1210.5, 1222.5, 1225, 1229, 
  1229.5, 1231.5, 1233, 1233.5, 1234, 1237.5, 1238, 1239.5, 1242, 1243.5, 1247, 
  1247.5, 1248, 1251.5, 1252, 1254, 1254.5, 1255, 1256, 1257, 1258, 1261, 
  1261.5, 1262.5, 1263, 1264, 1265, 1265.5, 1267, 1267.5, 1268, 1269, 1270.5, 
  1271.5, 1273.5, 1274, 1274.5, 1275.5, 1276, 1277, 1277.5, 1278.5, 1279, 
  1280.5, 1281.5, 1282.5, 1283.5, 1284.5, 1285.5, 1286, 1288.5, 1289.5, 1290, 
  1290.5, 1295, 1296.5, 1297, 1298.5, 1299, 1301.5, 1302, 1304, 1306, 1307.5, 
  1309, 1316.5, 1317.5, 1320, 1323.5, 1326.5, 1328.5, 1330.5, 1332, 1332.5, 
  1335.5, 1338, 1339, 1340.5, 1344, 1349, 1359, 1359.5, 1368.5, 1374.5, 1378, 
  1378.5, 1381, 1382, 1382.5, 1385, 1385.5, 1387.5, 1388, 1388.5, 1393.5, 
  1394.5, 1396, 1398.5, 1400, 1402.5, 1405.5, 1407.5, 1408, 1408.5, 1409, 1410, 
  1412.5, 1414, 1416.5, 1419, 1420, 1422.5, 1424, 1425, 1429, 1430, 1434, 
  1435.5, 1438, 1440, 1440.5, 1442, 1444, 1444.5, 1446.5, 1449, 1451, 1451.5, 
  1454, 1455.5, 1456.5, 1459, 1459.5, 1466, 1471.5, 1472.5, 1475.5, 1481, 1482, 
  1488, 1488.5, 1493, 1504, 1509, 1510.5, 1515, 1525.5, 1533, 1534.5, 1539.5, 
  1540, 1543, 1543.5, 1545.5, 1549, 1552, 1554, 1558, 1566.5, 1570, 1572.5, 
  1574.5, 1575, 1585, 1585.5, 1587, 1589, 1594, 1600.5, 1605, 1608, 1615.5, 
  1617, 1621.5, 1627, 1631.5, 1634.5, 1645, 1646, 1647.5, 1650.5, 1651.5, 
  1656.5, 1658, 1665.5, 1666, 1668.5, 1670.5, 1671, 1675, 1683, 1685.5, 1690, 
  1695, 1703.5, 1710, 1714.5, 1720, 1741.5, 1743, 1757, 1767.5, 1778, 1788.5, 
  1805, 2391, 2619.5, 2643.5, 2667, 2687, 2700.5, 2713, 2803, 2973.5, 3105.5, 
  3154.5, 3167.5, 3270.5, 4048, 4070.5, 4087, 4097.5, 4114, 4122, 4133, 4136.5, 
  4172, 4199, 4203, 4207, 4218, 4238.5, 4265.5, 4298.5, 4313.5, 4333.5, 4359.5, 
  4374.5, 4380, 4391.5, 4408, 4426.5, 4439, 4440, 4465, 4467.5, 4474.5, 4489, 
  4523, 4527.5, 4533, 4534.5, 4538.5, 4541, 4542, 4646, 4777.5, 4782, 4809.5, 
  4810, 4810.5, 4855.5, 4856, 4856.5, 4857, 4857.5, 4858, 4858.5, 4859, 4859.5, 
  4861.5, 4862, 4864.5, 4865.5, 4881, 4886, 4897, 4905.5, 4906, 4906.5, 4909.5, 
  4910, 4910.5, 4911, 4911.5, 4912, 4912.5, 4913, 4913.5, 4919.5, 4928.5, 4943, 
  4951, 4952, 4952.5, 4953, 4955.5, 4956, 4956.5, 4957.5, 4958, 4958.5, 4959, 
  4959.5, 4960, 4960.5, 4961, 4961.5, 4962, 4962.5, 4963, 4963.5, 4964, 4964.5, 
  4965, 4965.5, 4966, 4966.5, 4967, 4967.5, 4968.5, 4969, 4981.5, 4983, 4984, 
  4985, 4990.5, 5006.5, 5022.5, 4977600, 4990550, 5000150, 5004550, 5013100, 
  5016100, 5019900, 5020500, 5031350, 5033900, 5042450, 5045350, 5046850, 
  5049850, 5053900, 5061300, 5087650, 5109850, 5137700, 5145050, 5147450, 
  5152150, 5163600, 5183650, 5193400, 5209550, 5211950, 
};

static const int th_begin[] = {
  0, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 
  150, 151, 152, 153, 154, 155, 156, 156, 157, 158, 159, 160, 161, 162, 163, 
  164, 164, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 
  177, 178, 179, 214, 269, 281, 282, 283, 284, 309, 422, 535, 1306, 
};

static const int th_len[] = {
  135, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 
  1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 35, 55, 
  12, 1, 1, 1, 25, 113, 113, 771, 27, 
};

/*
 * \brief Function to convert a feature value into bin index.
 * \param val Feature value, in floating-point
 * \param fid Feature identifier
 * \return bin Index corresponding to given feature value
 */
int quantize(double val, unsigned fid) {
  const size_t offset = th_begin[fid];
  const double* array = &threshold[offset];
  int len = th_len[fid];
  int low = 0;
  int high = len;
  int mid;
  double mval;
  // It is possible th_begin[i] == [total_num_threshold]. This means that
  // all features i, (i+1), ... are not used for any of the splits in the model.
  // So in this case, just return something
  if (offset == 1333 || val < array[0]) {
    return -10;
  }
  while (low + 1 < high) {
    mid = (low + high) / 2;
    mval = array[mid];
    if (val == mval) {
      return mid * 2;
    } else if (val < mval) {
      high = mid;
    } else {
      low = mid;
    }
  }
  if (array[low] == val) {
    return low * 2;
  } else if (high == len) {
    return len * 2;
  } else {
    return low * 2 + 1;
  }
}

